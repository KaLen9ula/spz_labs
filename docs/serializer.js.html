<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>serializer.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Dentry.html">Dentry</a></li><li><a href="module-Device.html">Device</a><ul class='methods'><li data-type='method'><a href="module-Device.html#readBlock#readBlock">readBlock</a></li><li data-type='method'><a href="module-Device.html#writeBlock#writeBlock">writeBlock</a></li></ul></li><li><a href="module-Driver.html">Driver</a><ul class='methods'><li data-type='method'><a href="module-Driver.html#_addLink#_addLink">_addLink</a></li><li data-type='method'><a href="module-Driver.html#_appendBlockToINode#_appendBlockToINode">_appendBlockToINode</a></li><li data-type='method'><a href="module-Driver.html#_descreaseINode#_descreaseINode">_descreaseINode</a></li><li data-type='method'><a href="module-Driver.html#_getBlocks#_getBlocks">_getBlocks</a></li><li data-type='method'><a href="module-Driver.html#_getDirPath#_getDirPath">_getDirPath</a></li><li data-type='method'><a href="module-Driver.html#_getFileName#_getFileName">_getFileName</a></li><li data-type='method'><a href="module-Driver.html#_getUnusedDescriptor#_getUnusedDescriptor">_getUnusedDescriptor</a></li><li data-type='method'><a href="module-Driver.html#_increaseINode#_increaseINode">_increaseINode</a></li><li data-type='method'><a href="module-Driver.html#_read#_read">_read</a></li><li data-type='method'><a href="module-Driver.html#_readDirectory#_readDirectory">_readDirectory</a></li><li data-type='method'><a href="module-Driver.html#_removeLastBlocksFromINode#_removeLastBlocksFromINode">_removeLastBlocksFromINode</a></li><li data-type='method'><a href="module-Driver.html#_removeOrUpdate#_removeOrUpdate">_removeOrUpdate</a></li><li data-type='method'><a href="module-Driver.html#_setDescriptorBlock#_setDescriptorBlock">_setDescriptorBlock</a></li><li data-type='method'><a href="module-Driver.html#_setN#_setN">_setN</a></li><li data-type='method'><a href="module-Driver.html#_truncate#_truncate">_truncate</a></li><li data-type='method'><a href="module-Driver.html#_unlink#_unlink">_unlink</a></li><li data-type='method'><a href="module-Driver.html#_updateDescriptor#_updateDescriptor">_updateDescriptor</a></li><li data-type='method'><a href="module-Driver.html#_write#_write">_write</a></li><li data-type='method'><a href="module-Driver.html#close#close">close</a></li><li data-type='method'><a href="module-Driver.html#create#create">create</a></li><li data-type='method'><a href="module-Driver.html#getDescriptor#getDescriptor">getDescriptor</a></li><li data-type='method'><a href="module-Driver.html#link#link">link</a></li><li data-type='method'><a href="module-Driver.html#lookUp#lookUp">lookUp</a></li><li data-type='method'><a href="module-Driver.html#mkdir#mkdir">mkdir</a></li><li data-type='method'><a href="module-Driver.html#mkfs#mkfs">mkfs</a></li><li data-type='method'><a href="module-Driver.html#open#open">open</a></li><li data-type='method'><a href="module-Driver.html#read#read">read</a></li><li data-type='method'><a href="module-Driver.html#readDirectory#readDirectory">readDirectory</a></li><li data-type='method'><a href="module-Driver.html#rmdir#rmdir">rmdir</a></li><li data-type='method'><a href="module-Driver.html#symlink#symlink">symlink</a></li><li data-type='method'><a href="module-Driver.html#truncate#truncate">truncate</a></li><li data-type='method'><a href="module-Driver.html#unlink#unlink">unlink</a></li><li data-type='method'><a href="module-Driver.html#write#write">write</a></li></ul></li><li><a href="module-FileType.html">FileType</a></li><li><a href="module-INode.html">INode</a></li></ul><h3>Global</h3><ul><li><a href="global.html#deserializeAddress">deserializeAddress</a></li><li><a href="global.html#deserializeAddresses">deserializeAddresses</a></li><li><a href="global.html#deserializeDentries">deserializeDentries</a></li><li><a href="global.html#deserializeDentry">deserializeDentry</a></li><li><a href="global.html#deserializeFileType">deserializeFileType</a></li><li><a href="global.html#deserializeInode">deserializeInode</a></li><li><a href="global.html#deserializeInt16">deserializeInt16</a></li><li><a href="global.html#deserializeInt32">deserializeInt32</a></li><li><a href="global.html#serializeAddress">serializeAddress</a></li><li><a href="global.html#serializeAddresses">serializeAddresses</a></li><li><a href="global.html#serializeDentries">serializeDentries</a></li><li><a href="global.html#serializeDentry">serializeDentry</a></li><li><a href="global.html#serializeFileType">serializeFileType</a></li><li><a href="global.html#serializeInode">serializeInode</a></li><li><a href="global.html#serializeInt16">serializeInt16</a></li><li><a href="global.html#serializeInt32">serializeInt32</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">serializer.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Dentry from "./dentry.js";
import INode, { FileType } from "./inode.js";
import {
  ADDRESS_SIZE,
  DENTRY_SIZE,
  INODE_INO_SIZE,
  INODE_REFS_SIZE,
  INODE_SIZE,
  INODE_SIZE_SIZE,
  INODE_STRAIGHT_LINKS_COUNT,
  INODE_TYPE_SIZE,
  N_SIZE,
} from "./settings.js";

/**
 *
 * @param {Dentry} dentry Directory entry
 * @return {Uint8Array} Bytes reprasentation
 */
const serializeDentry = (dentry) => {
  const buff = new Uint8Array(DENTRY_SIZE);
  const filenameBytes = new TextEncoder().encode(
    dentry.fileName.substring(0, DENTRY_SIZE - N_SIZE)
  );

  buff.set(filenameBytes, 0);
  buff.set(serializeInt32(dentry.ino), DENTRY_SIZE - N_SIZE);
  return buff;
};

/**
 *
 * @param {Uint8Array} bytes Bytes reprasentation
 * @returns {Dentry} Directory entry
 */
const deserializeDentry = (bytes) => {
  const filenameBytes = bytes.subarray(0, DENTRY_SIZE - N_SIZE);
  const filename = new TextDecoder().decode(
    filenameBytes.subarray(0, filenameBytes.indexOf(0))
  );
  const inoBytes = bytes.subarray(DENTRY_SIZE - N_SIZE);
  const ino = deserializeInt32(inoBytes);

  const dentry = new Dentry(filename, ino);
  return dentry;
};

/**
 *
 * @param {Dentry[]} dentries Directory entries
 * @return {Uint8Array} Bytes reprasentation
 */
const serializeDentries = (dentries) => {
  const buff = new Uint8Array(DENTRY_SIZE * dentries.length);

  dentries.forEach((dentry, index) => {
    const dentryBytes = serializeDentry(dentry);
    buff.set(dentryBytes, index * DENTRY_SIZE);
  });

  return buff;
};

/**
 *
 * @param {Uint8Array} bytes Bytes reprasentation
 * @returns {Dentry[]} Directory entreis
 */
const deserializeDentries = (bytes) => {
  const dentries = [];
  for (let offset = 0; offset &lt; bytes.length; offset += DENTRY_SIZE) {
    const dentryBytes = bytes.subarray(offset, offset + DENTRY_SIZE);
    const dentry = deserializeDentry(dentryBytes);
    dentries.push(dentry);
  }
  return dentries;
};

/**
 *
 * @param {INode} inode File descriptor
 * @return {Uint8Array} Bytes reprasentation
 */
const serializeInode = (inode) => {
  const buff = new Uint8Array(INODE_SIZE);
  const inoBytes = serializeInt32(inode.ino);
  const typeBytes = serializeFileType(inode.type);
  const refsBytes = serializeInt16(inode.refs);
  const sizeBytes = serializeInt32(inode.size);
  const straightLinksBytes = inode.straightLinks.flatMap((link) => [
    ...serializeAddress(link),
  ]);
  const singleIndirectBytes = serializeAddress(inode.singleIndirect);
  const doubleIndirectBytes = serializeAddress(inode.doubleIndirect);

  buff.set(
    [
      ...inoBytes,
      ...typeBytes,
      ...refsBytes,
      ...sizeBytes,
      ...straightLinksBytes,
      ...singleIndirectBytes,
      ...doubleIndirectBytes,
    ],
    0
  );

  return buff;
};

/**
 *
 * @param {Uint8Array} bytes
 * @returns {INode} File descriptor
 */
const deserializeInode = (bytes) => {
  let offset = 0;
  const inoBytes = bytes.subarray(offset, INODE_INO_SIZE);
  offset += INODE_INO_SIZE;
  const typeBytes = bytes.subarray(offset, offset + INODE_TYPE_SIZE);
  offset += INODE_TYPE_SIZE;
  const refsBytes = bytes.subarray(offset, offset + INODE_REFS_SIZE);
  offset += INODE_REFS_SIZE;
  const sizeBytes = bytes.subarray(offset, offset + INODE_SIZE_SIZE);
  offset += INODE_SIZE_SIZE;
  const straightLinksBytes = bytes.subarray(
    offset,
    offset + ADDRESS_SIZE * INODE_STRAIGHT_LINKS_COUNT
  );
  offset += ADDRESS_SIZE * INODE_STRAIGHT_LINKS_COUNT;
  const singleIndirectBytes = bytes.subarray(offset, offset + ADDRESS_SIZE);
  const doubleIndirectBytes = bytes.subarray(offset, offset + ADDRESS_SIZE);

  const ino = deserializeInt32(inoBytes);
  const type = deserializeFileType(typeBytes);
  const refs = deserializeInt16(refsBytes);
  const size = deserializeInt32(sizeBytes);
  const straightLinks = [];
  for (let linkIndex = 0; linkIndex &lt; INODE_STRAIGHT_LINKS_COUNT; linkIndex++) {
    const linkBytes = straightLinksBytes.subarray(
      linkIndex * ADDRESS_SIZE,
      (linkIndex + 1) * ADDRESS_SIZE
    );
    const link = deserializeAddress(linkBytes);
    straightLinks.push(link);
  }
  const singleIndirect = deserializeAddress(singleIndirectBytes);
  const doubleIndirect = deserializeAddress(doubleIndirectBytes);

  const inode = new INode(
    ino,
    type,
    size,
    refs,
    straightLinks,
    singleIndirect,
    doubleIndirect
  );
  return inode;
};

/**
 *
 * @param {FileType} type
 * @return {Uint8Array}
 */
const serializeFileType = (type) => {
  switch (type) {
    case FileType.REGULAR:
      return new Uint8Array([0, 1]);
    case FileType.DIRECTORY:
      return new Uint8Array([0, 2]);
    case FileType.SYMLINK:
      return new Uint8Array([0, 3]);
    case FileType.UNUSED:
      return new Uint8Array([0, 0]);
    default:
      return new Uint8Array([0, 0]);
  }
};

/**
 *
 * @param {Uint8Array} bytes
 * @returns {FileType}
 */
const deserializeFileType = (bytes) => {
  if (bytes[0] == 0 &amp;&amp; bytes[1] == 1) {
    return FileType.REGULAR;
  } else if (bytes[0] == 0 &amp;&amp; bytes[1] == 2) {
    return FileType.DIRECTORY;
  } else if (bytes[0] == 0 &amp;&amp; bytes[1] == 3) {
    return FileType.SYMLINK;
  } else if (bytes[0] == 0 &amp;&amp; bytes[1] == 0) {
    return FileType.UNUSED;
  } else {
    return FileType.UNUSED;
  }
};

/**
 *
 * @param {int} address
 * @returns {Uint8Array} Bytes reprasentation
 */
const serializeAddress = (address) => {
  return serializeInt32(address);
};

/**
 *
 * @param {Uint8Array} bytes Bytes reprasentation
 * @returns {int} Address
 */
const deserializeAddress = (bytes) => {
  return deserializeInt32(bytes);
};

/**
 *
 * @param {Uint8Array} bytes Bytes reprasentation
 * @returns {int[]} Addresses
 */
const deserializeAddresses = (bytes) => {
  const addresses = [];
  for (let offset = 0; offset &lt; bytes.length; offset += ADDRESS_SIZE) {
    const addressBytes = bytes.subarray(
      offset * ADDRESS_SIZE,
      (offset + 1) * ADDRESS_SIZE
    );
    const address = deserializeAddress(addressBytes);
    addresses.push(address);
  }

  return addresses;
};

/**
 *
 * @param {int[]} addresses
 * @returns {Uint8Array} Bytes reprasentation
 */
const serializeAddresses = (addresses) => {
  const buff = Uint8Array(addresses.length * ADDRESS_SIZE);
  addresses.forEach((address, index) => {
    const addressBytes = serializeAddress(address);
    buff.set(addressBytes, index * ADDRESS_SIZE);
  });
  return buff;
};

/**
 *
 * @param {int} value
 * @returns {Uint8Array}
 */
const serializeInt32 = (value) => {
  return new Uint8Array([
    value >> 24,
    (value &lt;&lt; 8) >> 24,
    (value &lt;&lt; 16) >> 24,
    (value &lt;&lt; 24) >> 24,
  ]);
};

/**
 *
 * @param {Uint8Array} bytes
 * @returns
 */
const deserializeInt32 = (bytes) => {
  return (bytes[0] &lt;&lt; 24) + (bytes[1] &lt;&lt; 16) + (bytes[2] &lt;&lt; 8) + bytes[3];
};

/**
 *
 * @param {int} value
 */
const serializeInt16 = (value) => {
  return new Uint8Array([value >> 8, (value &lt;&lt; 8) >> 8]);
};

/**
 *
 * @param {Uint8Array} bytes
 * @returns
 */
const deserializeInt16 = (bytes) => {
  return (bytes[0] &lt;&lt; 8) + bytes[1];
};

export {
  // ----- Dentry -----
  serializeDentry,
  deserializeDentry,
  serializeDentries,
  deserializeDentries,
  // ------ INode -----
  serializeInode,
  deserializeInode,
  // ---- Address -----
  serializeAddress,
  deserializeAddress,
  serializeAddresses,
  deserializeAddresses,
  // ----- Int ----
  serializeInt32,
  deserializeInt32,
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Tue Dec 21 2021 14:39:25 GMT+0200 (Восточная Европа, стандартное время) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
